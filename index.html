<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PPLE Policy Poster Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    @font-face {
      font-family: 'Anakotmai';
      src: url('fonts/anakotmai/anakotmai-light.woff2') format('woff2'),
           url('fonts/anakotmai/anakotmai-light.woff') format('woff');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Anakotmai';
      src: url('fonts/anakotmai/anakotmai-medium.woff2') format('woff2'),
           url('fonts/anakotmai/anakotmai-medium.woff') format('woff');
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Anakotmai';
      src: url('fonts/anakotmai/anakotmai-bold.woff2') format('woff2'),
           url('fonts/anakotmai/anakotmai-bold.woff') format('woff');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Anakotmai';
      src: url('fonts/anakotmai/anakotmai-bold.woff2') format('woff2'),
           url('fonts/anakotmai/anakotmai-bold.woff') format('woff');
      font-weight: 900;
      font-style: normal;
      font-display: swap;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 100%;
    }

    .toolbar {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
      justify-content: space-between;
      gap: 20px;
    }

    .toolbar h1 {
      margin: 0;
      font-size: 24px;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toolbar-buttons {
      display: flex;
      gap: 10px;
    }

    kbd {
      background: white;
      border: 1px solid #cbd5e0;
      border-radius: 3px;
      padding: 2px 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .info-banner {
      background: #edf2f7;
      padding: 12px 30px;
      color: #4a5568;
      font-size: 14px;
      border-bottom: 1px solid #e2e8f0;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 250px;
      background: #f7fafc;
      border-right: 1px solid #e2e8f0;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 15px;
      background: white;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #2d3748;
      font-size: 14px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .policy-list {
      padding: 10px;
    }

    .policy-item {
      padding: 10px 12px;
      margin-bottom: 5px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      color: #4a5568;
    }

    .policy-item:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
      transform: translateX(3px);
    }

    .policy-item.active {
      background: #002A47;
      color: white;
      border-color: #002A47;
    }

    .policy-item-code {
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .policy-item-number {
      display: inline-block;
      min-width: 35px;
      color: #a0aec0;
      font-size: 12px;
      margin-right: 8px;
    }

    .sidebar-url-input {
      padding: 15px;
      background: white;
      border-top: 2px solid #e2e8f0;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    .sidebar-url-input input {
      width: 100%;
      padding: 8px 10px;
      border: 2px solid #cbd5e0;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .sidebar-url-input input:focus {
      outline: none;
      border-color: #667eea;
    }

    .sidebar-url-input button {
      width: 100%;
      padding: 8px;
      font-size: 12px;
      justify-content: center;
    }

    .preview-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      padding: 20px;
      background: #f7fafc;
    }

    .preview-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    #poster {
      width: 1200px;
      height: 1600px;
      position: relative;
      background-color: #002A47;
      overflow: hidden;
      transform-origin: center center;
      background: url('template/template_bg_only_2.svg');
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .background-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .background-shape {
      position: absolute;
      top: 0;
      left: 0;
      width: 1200px;
      height: 1600px;
      overflow: hidden;
      z-index: 0;
    }

    .background-shape svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .background-image-overlay {
      position: absolute;
      top: 880px;
      left: 0;
      width: 1200px;
      height: 720px;
      clip-path: polygon(0 50%, 100% 0%, 100% 100%, 0 100%);
      mix-blend-mode: multiply;
      pointer-events: none;
      z-index: 1;
    }

    .background-image-overlay img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: grayscale(100%);
      opacity: 0.8;
    }

    .image-upload-control {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .image-upload-control.hidden {
      transform: translateX(calc(100% + 20px));
      opacity: 0;
      pointer-events: none;
    }

    .image-toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      transition: all 0.2s;
    }

    .image-toggle-btn:hover {
      background: #f7fafc;
      transform: scale(1.05);
    }

    .image-toggle-btn svg {
      width: 24px;
      height: 24px;
      color: #4a5568;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .panel-close-btn {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: #718096;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .panel-close-btn:hover {
      background: #edf2f7;
      color: #2d3748;
    }

    .panel-close-btn svg {
      width: 18px;
      height: 18px;
    }

    .image-upload-control label {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
    }

    .image-upload-control input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 12px;
    }

    .image-upload-control input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .image-upload-control input[type="file"] {
      font-size: 12px;
    }

    .image-upload-control button {
      padding: 8px 12px;
      font-size: 12px;
    }

    .divider {
      position: absolute;
      top: 962px;
      left: 120px;
      width: 960px;
      height: 1px;
      background: white;
      z-index: 1;
    }

    .ballot-boxes {
      position: absolute;
      left: 560px;
      top: 1364px;
      display: flex;
      gap: 4px;
      z-index: 1;
    }

    .ballot-box {
      width: 140px;
      height: 140px;
      border: 2px solid black;
      position: relative;
    }

    .ballot-box.purple {
      background: #DE9AE7;
    }

    .ballot-box.white {
      background: white;
    }

    .ballot-box.green {
      background: #6EE18B;
    }

    .ballot-x {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .ballot-x::before,
    .ballot-x::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      width: 80%;
      height: 11px;
      background: black;
      border-radius: 6px;
    }

    .ballot-x::before {
      transform: translate(-50%, -50%) rotate(45deg);
    }

    .ballot-x::after {
      transform: translate(-50%, -50%) rotate(-45deg);
    }

    .ballot-number {
      position: absolute;
      font-family: 'Anakotmai', sans-serif;
      font-size: 84px;
      font-weight: 900;
      color: black;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }

    .ballot-checkmark {
      position: absolute;
      top: 18px;
      left: 24px;
      width: 50px;
      height: 70px;
      font-family: 'Anakotmai', sans-serif;
      font-size: 48px;
      font-weight: 900;
      color: black;
    }

    /* Editable text elements */
    [contenteditable="true"] {
      outline: none;
      cursor: text;
      transition: background 0.2s;
    }

    [contenteditable="true"]:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    [contenteditable="true"]:focus {
      background: rgba(102, 126, 234, 0.2);
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
      border-radius: 4px;
    }

    .content {
      position: absolute;
      top: 160px;
      left: 120px;
      right: 120px;
      z-index: 2;
      font-family: 'Anakotmai', sans-serif;
    }

    .policy-title {
      padding-bottom: 80px;
      border-bottom: 1px #fff solid;
      margin-bottom: 80px;
    }

    .text-policy-number {
      font-family: 'Anakotmai', sans-serif;
      font-size: 32px;
      font-weight: 400;
      color: white;
      position: absolute;
      top: 40px;
      left: 40px;
    }

    .text-policy-category {
      font-family: 'Anakotmai', sans-serif;
      font-size: 40px;
      font-weight: 300;
      color: white;
      /* text-shadow: 0 8px 16px rgba(0, 0, 0, 1); */
      margin-bottom: 24px;
      padding-right: -24px;
      line-height: 1.33;
      /* white-space: nowrap; */
    }

    .text-main-title {
      font-size: 96px;
      font-weight: 900;
      line-height: 1.2;
      color: white;
      /* text-shadow: 0 8px 16px rgba(0, 0, 0, 1); */
      margin-bottom: 24px;
    }

    .text-description {
      font-family: 'Anakotmai', sans-serif;
      font-size: 48px;
      font-weight: 500;
      line-height: 1.33;
      color: #FF6413;
      /* text-shadow: 0 8px 16px rgba(0, 0, 0, 1); */
    }

    .pple-overlay {
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    .qr-group {
      display: flex;
      gap: 40px;
      align-items: start;
      flex-direction: row;
    }

    .qr-code {
      /* position: absolute; */
      /* left: 120px; */
      /* top: 1042px; */
      width: 180px;
      height: 180px;
      background: white;
      z-index: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .qr-code canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .text-qr-title {
      font-size: 40px;
      font-weight: 500;
      color: white;
      line-height: 1.40;
      margin-bottom: 4px;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
    }

    .text-qr-url {
      font-family: 'Anakotmai', sans-serif;
      font-size: 24px;
      font-weight: 500;
      /* color: #FF6413; */
      color: #ffffff;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
    }

    .text-vote-date {
      position: absolute;
      left: 362px;
      top: 1380px;
      font-family: 'Anakotmai', sans-serif;
      font-size: 40px;
      font-weight: 500;
      line-height: 1.2;
      color: white;
      text-align: center;
      z-index: 2;
      padding: 4px;
    }

    .text-party-name {
      position: absolute;
      left: 288px;
      top: 1475px;
      font-family: 'Anakotmai', sans-serif;
      font-size: 40px;
      font-weight: 500;
      color: #FF6413;
      z-index: 2;
      padding: 4px;
    }

    .text-ballot-info1 {
      position: absolute;
      left: 576px;
      top: 1518px;
      font-family: 'Anakotmai', sans-serif;
      font-size: 24px;
      font-weight: 500;
      color: white;
      z-index: 2;
      padding: 4px;
    }

    .text-ballot-info2 {
      position: absolute;
      left: 868px;
      top: 1518px;
      font-family: 'Anakotmai', sans-serif;
      font-size: 24px;
      font-weight: 500;
      color: white;
      z-index: 2;
      padding: 4px;
    }

    .text-footer {
      position: absolute;
      left: 150px;
      bottom: 16px;
      font-family: sans-serif;
      font-size: 16px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.4);
      z-index: 2;
      max-width: 900px;
      padding: 4px;
    }

    .btn-primary,
    .btn-secondary {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #CC500F;
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .icon {
      width: 20px;
      height: 20px;
    }

    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .toolbar-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div>
        <b>Policy Poster Editor</b> - ‡∏Å‡∏î‡πÅ‡∏Å‡πâ text ‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚Ä¢ <kbd>j</kbd>/<kbd>k</kbd> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤/‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚Ä¢ <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>&lt;</kbd>/<kbd>&gt;</kbd>/<kbd>/</kbd> ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå ‚Ä¢ <kbd>Ctrl</kbd>+<kbd>S</kbd> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PNG
      </div>
      <div class="toolbar-buttons">
        <button class="btn-secondary" onclick="resetToOriginal()">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
            </path>
          </svg>
          Reset
        </button>
        <button class="btn-secondary" onclick="clearAllAndRefresh()">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
            </path>
          </svg>
          Clear All
        </button>
        <button class="btn-primary" onclick="exportAsPNG()" id="exportBtn">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          Export PNG (Ctrl+S)
        </button>
      </div>
    </div>

    <!-- Info Banner -->
    <!-- <div class="info-banner">
      üí° Click on any text to edit it directly. Your changes are instantly visible!
    </div> -->

    <!-- Main Content with Sidebar -->
    <div class="main-content">
      <!-- Sidebar with Policy List -->
      <div class="sidebar">
        <div class="sidebar-header">
          üìã Policies (203)
        </div>
        <!-- <div style="padding: 8px 15px; background: #edf2f7; font-size: 12px; color: #4a5568; border-bottom: 1px solid #e2e8f0;">
          ‚å®Ô∏è Use <kbd>j</kbd>/<kbd>k</kbd> to navigate ‚Ä¢ <kbd>Ctrl+S</kbd> to export
        </div> -->
        <div class="policy-list" id="policyList">
          <div style="padding: 20px; text-align: center; color: #a0aec0;">
            Loading policies...
          </div>
        </div>
        <div class="sidebar-url-input">
          <input type="text" id="policyUrlInput" placeholder="Paste policy URL..." />
          <button class="btn-primary" onclick="fetchPolicyData()">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Fetch from URL
          </button>
        </div>
      </div>

      <!-- Poster Preview -->
      <div class="preview-container">
      <div class="preview-wrapper">
        <div id="poster">

          <!-- Background -->
          <div class="background-layer">
            <div class="background-shape">
              <svg viewBox="0 0 1200 1600" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 1240L1200 880V1600H0V1240Z" fill="#A53E09"/>
              </svg>
            </div>
            <div class="background-image-overlay" id="imageOverlay">
              <img id="overlayImage" src="" alt="" style="display: none;">
            </div>
          </div>
          <img src="template/overlay.svg" class="pple-overlay">
          
          <div class="text-policy-number" contenteditable="true" data-default="‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 1/200: ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢">
            ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 1/200
          </div>
          <!-- Editable Text Elements -->
          <div class="content">
            <div class="policy-title">
              <div class="text-policy-category" contenteditable="true" data-default="‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 1/200: ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢">
                ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢
              </div>
              <div class="text-main-title" contenteditable="true"
                data-default="‡∏™‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∞‡∏•‡∏±‡∏Å-<br>‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤-‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°:<br>‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°<br>‡πÅ‡∏•‡∏∞ SMEs ‡πÑ‡∏ó‡∏¢">
                ‡∏™‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∞‡∏•‡∏±‡∏Å-<br>‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤-‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°:<br>‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°<br>‡πÅ‡∏•‡∏∞ SMEs ‡πÑ‡∏ó‡∏¢
              </div>
              <div class="text-description" contenteditable="true"
                data-default="‡πÉ‡∏ä‡πâ Fast Track ‡∏™‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡πà‡∏°‡∏ï‡∏•‡∏≤‡∏î<br>‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ï‡πà‡∏™‡∏ß‡∏ô 40% ‡∏°‡∏µ AI ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤<br>‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏°‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡πà‡∏ß‡∏¢ SMEs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏ó‡∏¢">
                ‡πÉ‡∏ä‡πâ Fast Track ‡∏™‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡πà‡∏°‡∏ï‡∏•‡∏≤‡∏î<br>‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ï‡πà‡∏™‡∏ß‡∏ô 40% ‡∏°‡∏µ AI ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤<br>‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏°‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡πà‡∏ß‡∏¢ SMEs
                ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏ó‡∏¢
              </div>
            </div>
            <div class="qr-group">
              <div class="qr-code" id="qrCode"></div>
            <div class="qr-text-group">
              <div class="text-qr-title" contenteditable="true" data-default="‡∏ó‡∏≥‡∏ó‡∏≥‡πÑ‡∏°? ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£? ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?\n‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
                ‡∏ó‡∏≥‡∏ó‡∏≥‡πÑ‡∏°? ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£? ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?<br/>
                ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
              </div>
              <div class="text-qr-url" contenteditable="true" id="qrUrlText"
                data-default="https://election69.peoplesparty.or.th/policy/3/A-1-4"
                oninput="updateQRCode()">
                https://election69.peoplesparty.or.th/policy/3/A-1-4</div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Toggle Button -->
    <button class="image-toggle-btn" onclick="toggleImagePanel()" title="Toggle image controls">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
    </button>

    <!-- Image Upload Control -->
    <div class="image-upload-control hidden" id="imageUploadControl">
      <div class="panel-header">
        <label>Background Image Overlay</label>
        <button class="panel-close-btn" onclick="toggleImagePanel()" title="Close panel">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <input type="text" id="imageUrlInput" placeholder="Enter image URL" />
      <button class="btn-secondary" onclick="loadImageFromUrl()">Load URL</button>
      <label>Or upload file:</label>
      <input type="file" id="imageFileInput" accept="image/*" onchange="loadImageFromFile(event)" />
      <button class="btn-secondary" onclick="clearImage()">Clear Image</button>
    </div>
  </div>

  <script>
    // Store original content for reset
    const originalContent = {};
    const originalFontSizes = {};
    let currentImageUrl = '';
    let policyUrls = [];
    let currentPolicyUrl = null;
    let currentPolicyIndex = 0;
    let focusedEditableElement = null;
    
    // LocalStorage functions
    function saveCurrentState() {
      if (!currentPolicyUrl) return;
      
      const state = {
        textContent: {},
        fontSizes: {},
        imageUrl: currentImageUrl,
        timestamp: Date.now()
      };
      
      // Save all editable text content and font sizes
      document.querySelectorAll('[contenteditable="true"]').forEach(el => {
        state.textContent[el.className] = el.innerHTML;
        state.fontSizes[el.className] = el.style.fontSize || '';
      });
      
      localStorage.setItem(`policy_state_${currentPolicyUrl}`, JSON.stringify(state));
    }
    
    function loadSavedState() {
      if (!currentPolicyUrl) return false;
      
      const savedState = localStorage.getItem(`policy_state_${currentPolicyUrl}`);
      if (!savedState) return false;
      
      try {
        const state = JSON.parse(savedState);
        
        // Restore text content and font sizes
        document.querySelectorAll('[contenteditable="true"]').forEach(el => {
          if (state.textContent[el.className]) {
            el.innerHTML = state.textContent[el.className];
          }
          if (state.fontSizes[el.className]) {
            el.style.fontSize = state.fontSizes[el.className];
          }
        });
        
        // Restore image
        if (state.imageUrl) {
          document.getElementById('imageUrlInput').value = state.imageUrl;
          const img = document.getElementById('overlayImage');
          img.src = state.imageUrl;
          img.style.display = 'block';
          currentImageUrl = state.imageUrl;
        } else {
          document.getElementById('overlayImage').style.display = 'none';
          currentImageUrl = '';
        }
        
        return true;
      } catch (error) {
        console.error('Error loading saved state:', error);
        return false;
      }
    }
    
    function clearSavedState() {
      if (!currentPolicyUrl) return;
      localStorage.removeItem(`policy_state_${currentPolicyUrl}`);
    }

    // Scale poster to fit viewport
    function scalePosterToFit() {
      const poster = document.getElementById('poster');
      const container = document.querySelector('.preview-container');
      
      if (!poster || !container) return;
      
      const containerRect = container.getBoundingClientRect();
      const availableWidth = containerRect.width - 40; // Account for padding
      const availableHeight = containerRect.height - 40;
      
      const posterWidth = 1200;
      const posterHeight = 1600;
      
      // Calculate scale factors for both dimensions
      const scaleX = availableWidth / posterWidth;
      const scaleY = availableHeight / posterHeight;
      
      // Use the smaller scale to ensure the poster fits completely
      const scale = Math.min(scaleX, scaleY, 1); // Cap at 1 to avoid upscaling
      
      poster.style.transform = `scale(${scale})`;
    }

    // Load policy URLs from JSON file
    async function loadPolicyList() {
      try {
        const response = await fetch('policy-urls.json');
        policyUrls = await response.json();
        
        const policyListEl = document.getElementById('policyList');
        policyListEl.innerHTML = '';
        
        policyUrls.forEach((url, index) => {
          const policyCode = url.split('/').pop();
          const runningNumber = index + 1;
          const item = document.createElement('div');
          item.className = 'policy-item';
          item.dataset.runningNumber = runningNumber;
          item.innerHTML = `<span class="policy-item-number">#${runningNumber}</span><span class="policy-item-code">${policyCode}</span>`;
          item.onclick = () => loadPolicyFromSidebar(url, item, runningNumber);
          policyListEl.appendChild(item);
        });
        
        console.log(`Loaded ${policyUrls.length} policies`);
        
        // Automatically load the first policy
        if (policyUrls.length > 0) {
          const firstItem = policyListEl.querySelector('.policy-item');
          loadPolicyFromSidebar(policyUrls[0], firstItem, 1);
        }
      } catch (error) {
        console.error('Error loading policy list:', error);
        document.getElementById('policyList').innerHTML = 
          '<div style="padding: 20px; text-align: center; color: #e53e3e;">‚ùå Failed to load policies</div>';
      }
    }

    // Load policy from sidebar click
    function loadPolicyFromSidebar(url, itemEl, runningNumber) {
      // Update active state
      document.querySelectorAll('.policy-item').forEach(el => el.classList.remove('active'));
      itemEl.classList.add('active');
      
      // Update current index
      currentPolicyIndex = parseInt(itemEl.dataset.runningNumber) - 1;
      
      // Store running number for use in policy number field
      window.currentRunningNumber = runningNumber;
      
      // Update URL input
      document.getElementById('policyUrlInput').value = url;
      currentPolicyUrl = url;
      
      // Try to load saved state first, otherwise fetch
      const hasSavedState = loadSavedState();
      if (hasSavedState) {
        console.log('Loaded saved state for:', url);
        updateQRCode();
      } else {
        // Reset font sizes to original before fetching
        document.querySelectorAll('[contenteditable="true"]').forEach(el => {
          const className = el.className;
          if (originalFontSizes[className]) {
            el.style.fontSize = originalFontSizes[className];
          } else {
            el.style.fontSize = '';
          }
        });
        fetchPolicyData();
      }
    }
    
    // Navigate to next policy
    function navigateToPolicy(direction) {
      const policyItems = document.querySelectorAll('.policy-item');
      if (policyItems.length === 0) return;
      
      // Calculate new index
      let newIndex = currentPolicyIndex + direction;
      
      // Wrap around
      if (newIndex < 0) newIndex = policyItems.length - 1;
      if (newIndex >= policyItems.length) newIndex = 0;
      
      // Load the policy
      const item = policyItems[newIndex];
      const url = policyUrls[newIndex];
      const runningNumber = newIndex + 1;
      
      loadPolicyFromSidebar(url, item, runningNumber);
      
      // Scroll into view
      item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Export shortcuts work everywhere (including Thai keyboard)
      if ((e.ctrlKey || e.metaKey) && (e.key === 'e' || e.key === 's' || e.key === '‡∏≥' || e.key === '‡∏™')) {
        e.preventDefault();
        exportAsPNG();
        return;
      }
      
      // Font size shortcuts when focused on contenteditable (with Ctrl+Alt modifier)
      if (e.target.isContentEditable && focusedEditableElement && (e.ctrlKey || e.metaKey) && e.altKey) {
        if (e.key === '>' || e.key === '.' || e.key === '‡πÉ') { // Thai: ‡πÉ
          e.preventDefault();
          adjustFontSize(focusedEditableElement, 2);
          return;
        } else if (e.key === '<' || e.key === ',' || e.key === '‡∏°') { // Thai: ‡∏°
          e.preventDefault();
          adjustFontSize(focusedEditableElement, -2);
          return;
        } else if (e.key === '/' || e.key === '?' || e.key === '‡∏ù') { // Thai: ‡∏ù
          e.preventDefault();
          resetFontSize(focusedEditableElement);
          return;
        }
      }
      
      // Ignore navigation shortcuts if typing in input field or contenteditable
      if (e.target.tagName === 'INPUT' || e.target.isContentEditable) {
        return;
      }
      
      // Arrow keys for navigation (including Thai keyboard ‡πà/‡∏≤)
      if (e.key === 'ArrowDown' || e.key === 'k' || e.key === '‡∏≤') {
        e.preventDefault();
        navigateToPolicy(1); // Next
      } else if (e.key === 'ArrowUp' || e.key === 'j' || e.key === '‡πà') {
        e.preventDefault();
        navigateToPolicy(-1); // Previous
      }
    });
    
    // Track focused editable element
    document.addEventListener('focusin', (e) => {
      if (e.target.isContentEditable) {
        focusedEditableElement = e.target;
      }
    });
    
    document.addEventListener('focusout', (e) => {
      if (e.target.isContentEditable) {
        focusedEditableElement = null;
      }
    });
    
    // Adjust font size
    function adjustFontSize(element, change) {
      const currentSize = parseFloat(window.getComputedStyle(element).fontSize);
      const newSize = Math.max(12, currentSize + change); // Minimum 12px
      element.style.fontSize = newSize + 'px';
    }
    
    // Reset font size to original
    function resetFontSize(element) {
      const className = element.className;
      if (originalFontSizes[className]) {
        element.style.fontSize = originalFontSizes[className];
      } else {
        element.style.fontSize = '';
      }
    }
    
    // Fetch and populate policy data from URL
    async function fetchPolicyData(event) {
      const urlInput = document.getElementById('policyUrlInput');
      const url = urlInput.value.trim();
      
      if (!url) {
        alert('Please enter a policy URL');
        return;
      }
      
      // Validate URL format
      if (!url.includes('election69.peoplesparty.or.th')) {
        alert('Please enter a valid People\'s Party policy URL');
        return;
      }
      
      try {
        // Show loading state
        let btn = event ? event.target : document.querySelector('.sidebar-url-input button');
        const originalBtnContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Fetching...';
        
        // Fetch the page content
        // Note: Due to CORS restrictions, we'll need to use a proxy or handle this differently
        // For now, we'll try direct fetch, but may need to use a CORS proxy
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error('Failed to fetch policy page');
        }
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        console.log('Parsing HTML from:', url);
        
        // Extract policy data with multiple selector attempts
        let title = doc.querySelector('h1')?.textContent?.trim() ||
                   doc.querySelector('.policy-title')?.textContent?.trim() ||
                   doc.querySelector('[class*="title"]')?.textContent?.trim() ||
                   doc.querySelector('meta[property="og:title"]')?.getAttribute('content');
        
        // Find subtitle - it's the p element under the policy title
        let subtitle = null;
        const h1Element = doc.querySelector('h1');
        if (h1Element) {
          // Try to find p element as next sibling or in parent container
          subtitle = h1Element.nextElementSibling?.tagName === 'P' ? h1Element.nextElementSibling.textContent?.trim() : null;
          
          // If not found, try parent's next p element
          if (!subtitle) {
            const parent = h1Element.parentElement;
            subtitle = parent?.querySelector('p')?.textContent?.trim();
          }
        }
        
        // Fallback to general p element search if still not found
        if (!subtitle) {
          subtitle = doc.querySelector('h1 + p')?.textContent?.trim() ||
                    doc.querySelector('article p')?.textContent?.trim() ||
                    doc.querySelector('meta[property="og:description"]')?.getAttribute('content') ||
                    doc.querySelector('meta[name="description"]')?.getAttribute('content');
        }
        
        // Extract policy directory/breadcrumb (category path)
        let policyDirectory = '';
        
        // Look for the specific div with category information
        const categoryDiv = doc.querySelector('.flex.flex-row.items-center.gap-3.w-fit.whitespace-nowrap.text-lg') ||
                           doc.querySelector('div[class*="flex"][class*="flex-row"][class*="items-center"]');
        
        if (categoryDiv) {
          // Since they use SVG chevrons instead of "/" text, extract text from child elements
          const textElements = categoryDiv.querySelectorAll('a, span, div');
          const categories = [];
          
          textElements.forEach(el => {
            // Skip SVG elements and empty text
            if (el.tagName !== 'svg' && !el.querySelector('svg')) {
              const text = el.textContent?.trim();
              if (text && text.length > 0 && text !== '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ') {
                categories.push(text);
              }
            }
          });
          
          console.log('Extracted categories from flex div:', categories);
          // Get the second item (index 1) after removing "‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ"
          // This is the third level overall: ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ (removed) / Level2 / Level3 (index 1)
          policyDirectory = categories[2] || categories[0] || '';
          
          console.log('Found category div (third level):', policyDirectory);
        }
        
        // Fallback: Try breadcrumb navigation
        if (!policyDirectory) {
          const breadcrumbSelectors = [
            'nav[aria-label="breadcrumb"]',
            '.breadcrumb',
            '[class*="breadcrumb"]',
            'nav ol',
            'nav ul'
          ];
          
          for (const selector of breadcrumbSelectors) {
            const breadcrumb = doc.querySelector(selector);
            if (breadcrumb) {
              const items = breadcrumb.querySelectorAll('li, a, span, div');
              const breadcrumbTexts = [];
              items.forEach(item => {
                // Skip SVG elements
                if (item.tagName !== 'svg' && !item.querySelector('svg')) {
                  const text = item.textContent?.trim();
                  // Skip separators (no longer "/" but could be empty or whitespace), home links, and "‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ"
                  if (text && text !== '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å' && text !== 'Home' && text !== '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ' &&
                      !text.match(/^\s*$/) && text.length > 1) {
                    breadcrumbTexts.push(text);
                  }
                }
              });
              console.log('Breadcrumb texts found:', breadcrumbTexts);
              // Get unique texts and extract the second item (index 1) 
              // This is third level after: ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ (filtered) / Level2 / Level3 (index 1)
              const uniqueTexts = [...new Set(breadcrumbTexts)].filter(t => t.length > 1);
              policyDirectory = uniqueTexts[1] || uniqueTexts[0] || '';
              if (policyDirectory && policyDirectory.length > 0) {
                console.log('Found via breadcrumb (third level):', policyDirectory);
                break;
              }
            }
          }
        }
        
        // Log for debugging if still not found
        if (!policyDirectory) {
          console.log('No directory found. Searching for flex divs...');
          const flexDivs = doc.querySelectorAll('div[class*="flex"]');
          console.log('Found flex divs:', flexDivs.length);
          flexDivs.forEach((div, i) => {
            if (i < 5) console.log(`Flex div ${i}:`, div.className, div.textContent?.substring(0, 100));
          });
        }
        
        console.log('Final extracted directory:', policyDirectory);
        
        const featuredImage = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || 
                             doc.querySelector('meta[name="twitter:image"]')?.getAttribute('content') ||
                             doc.querySelector('.featured-image img')?.src ||
                             doc.querySelector('.policy-image img')?.src ||
                             doc.querySelector('article img')?.src;
        
        console.log('Extracted data:', { title, subtitle, featuredImage });
        
        // Extract policy number from URL or page
        const urlParts = url.split('/');
        const policyId = urlParts[urlParts.length - 1];
        const policyCategory = urlParts[urlParts.length - 2];
        
        // Populate poster fields
        const titleEl = document.querySelector('.text-main-title');
        const subtitleEl = document.querySelector('.text-description');
        
        if (title) {
          titleEl.innerHTML = title.replace(/\n/g, '<br>');
          console.log('Title updated:', title);
        } else {
          console.warn('No title found');
        }
        
        if (subtitle && !subtitle.includes('‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô')) {
          subtitleEl.innerHTML = subtitle.replace(/\n/g, '<br>');
          subtitleEl.style.display = 'block';
          console.log('Subtitle updated:', subtitle);
        } else {
          subtitleEl.style.display = 'none';
          console.warn('No subtitle found or default text detected');
        }
        
        // Update policy number using running number
        const policyNumberEl = document.querySelector('.text-policy-number');
        const policyCategoryEl = document.querySelector('.text-policy-category');
        const runningNum = window.currentRunningNumber || '1';
        const totalPolicies = policyUrls.length || 203;
        
        // Set policy number
        policyNumberEl.innerHTML = `‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ${runningNum}/${totalPolicies}`;
        
        // Set policy category
        if (policyDirectory) {
          policyCategoryEl.innerHTML = policyDirectory;
        } else {
          policyCategoryEl.innerHTML = '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢';
        }
        
        // Update URL in QR code section
        const qrUrlEl = document.getElementById('qrUrlText');
        qrUrlEl.textContent = url;
        updateQRCode();
        
        // Load featured image if available
        if (featuredImage) {
          const imgUrl = featuredImage.startsWith('http') ? featuredImage : new URL(featuredImage, url).href;
          document.getElementById('imageUrlInput').value = imgUrl;
          loadImageFromUrl();
        }
        
        // Save initial state after fetching
        setTimeout(saveCurrentState, 500);
        
        // Restore button state
        btn.disabled = false;
        btn.innerHTML = originalBtnContent;
        
        // alert('‚úÖ Policy data loaded successfully!');
        
      } catch (error) {
        console.error('Error fetching policy data:', error);
        
        // Restore button state
        let btn = event ? event.target : document.querySelector('.sidebar-url-input button');
        btn.disabled = false;
        btn.innerHTML = '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> Fetch from URL';
        
        // If CORS error, provide helpful message
        if (error.message.includes('CORS') || error.message.includes('fetch')) {
          alert('‚ö†Ô∏è Unable to fetch due to CORS restrictions.\n\nPlease manually copy:\n‚Ä¢ Title\n‚Ä¢ Subtitle\n‚Ä¢ Image URL\n\nOr the page needs to allow cross-origin requests.');
        } else {
          alert('‚ùå Error: ' + error.message);
        }
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Store original content and font sizes
      document.querySelectorAll('[contenteditable="true"]').forEach(el => {
        originalContent[el.className] = el.innerHTML;
        originalFontSizes[el.className] = window.getComputedStyle(el).fontSize;
        
        // Add paste event listener to preserve styling
        el.addEventListener('paste', (e) => {
          e.preventDefault();
          
          // Get plain text from clipboard
          const text = (e.clipboardData || window.clipboardData).getData('text/plain');
          
          // Insert as plain text, preserving line breaks
          document.execCommand('insertHTML', false, text.replace(/\n/g, '<br>'));
        });
        
        // Save state on input
        el.addEventListener('input', () => {
          saveCurrentState();
        });
      });
      
      // Save state when image changes
      document.getElementById('imageUrlInput').addEventListener('change', () => {
        setTimeout(saveCurrentState, 100);
      });
      
      // Generate initial QR code
      updateQRCode();
      
      // Load policy list
      loadPolicyList();
    });

    // Generate/Update QR Code
    function updateQRCode() {
      // Check if QRCode library is loaded
      if (typeof QRCode === 'undefined') {
        console.log('QRCode library not loaded yet, retrying...');
        setTimeout(updateQRCode, 100);
        return;
      }
      
      const urlElement = document.getElementById('qrUrlText');
      const qrContainer = document.getElementById('qrCode');
      
      if (!urlElement || !qrContainer) {
        return;
      }
      
      // Get the text content (strip HTML tags)
      let url = urlElement.textContent || urlElement.innerText;
      url = url.trim();
      
      if (!url) {
        url = 'https://election69.peoplesparty.or.th/policy/3/A-1-4';
      }
      
      // Clear previous QR code
      qrContainer.innerHTML = '';
      
      // Generate new QR code using qrcodejs library
      new QRCode(qrContainer, {
        text: url,
        width: 160,
        height: 160,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    // Load image from URL (convert to data URL to avoid CORS issues)
    async function loadImageFromUrl() {
      const url = document.getElementById('imageUrlInput').value.trim();
      if (url) {
        try {
          // Convert to data URL to avoid CORS tainting
          const response = await fetch(url);
          const blob = await response.blob();
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.getElementById('overlayImage');
            img.src = e.target.result;
            img.style.display = 'block';
            currentImageUrl = e.target.result;
            saveCurrentState();
          };
          reader.readAsDataURL(blob);
        } catch (error) {
          console.error('Error loading image:', error);
          // Fallback to direct URL if fetch fails
          const img = document.getElementById('overlayImage');
          img.src = url;
          img.style.display = 'block';
          currentImageUrl = url;
          saveCurrentState();
        }
      }
    }

    // Load image from file
    function loadImageFromFile(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById('overlayImage');
          img.src = e.target.result;
          img.style.display = 'block';
          currentImageUrl = e.target.result;
          saveCurrentState();
        };
        reader.readAsDataURL(file);
      }
    }

    // Clear image
    function clearImage() {
      const img = document.getElementById('overlayImage');
      img.src = '';
      img.style.display = 'none';
      document.getElementById('imageUrlInput').value = '';
      document.getElementById('imageFileInput').value = '';
      currentImageUrl = '';
      saveCurrentState();
    }

    // Toggle image panel visibility
    function toggleImagePanel() {
      const panel = document.getElementById('imageUploadControl');
      panel.classList.toggle('hidden');
    }

    // Reset to original fetched data
    function resetToOriginal() {
      if (!currentPolicyUrl) {
        alert('Please load a policy first');
        return;
      }
      
      if (confirm('Reset to the original fetched data? This will discard your current edits.')) {
        // Clear saved state
        clearSavedState();
        
        // Reset font sizes
        document.querySelectorAll('[contenteditable="true"]').forEach(el => {
          el.style.fontSize = originalFontSizes[el.className] || '';
        });
        
        // Re-fetch from URL
        fetchPolicyData();
      }
    }
    
    // Clear all localStorage and refresh page
    function clearAllAndRefresh() {
      if (confirm('Clear all saved edits for ALL policies and refresh the page?')) {
        // Clear all localStorage items related to policies
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('policy_state_')) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Refresh the page
        location.reload();
      }
    }

    // Export as PNG using html2canvas
    async function exportAsPNG() {
      const button = document.getElementById('exportBtn');
      const originalContent = button.innerHTML;

      button.disabled = true;
      button.innerHTML = '<span class="loading"></span> Exporting...';

      try {
        const poster = document.getElementById('poster');
        const overlayImg = document.getElementById('overlayImage');

        // Store current transform and temporarily remove it for export
        const currentTransform = poster.style.transform;
        poster.style.transform = 'none';

        // Store original overlay state
        const originalOverlayParent = overlayImg.parentElement;
        
        // Process overlay image if present
        let tempCanvasContainer = null;
        
        if (overlayImg.style.display !== 'none' && overlayImg.src && overlayImg.src.length > 0) {
          try {
            // Wait for image to load and check if it's valid
            await new Promise((resolve, reject) => {
              if (overlayImg.complete && overlayImg.naturalWidth > 0) {
                resolve();
              } else if (overlayImg.complete && overlayImg.naturalWidth === 0) {
                reject(new Error('Image failed to load'));
              } else {
                overlayImg.onload = () => {
                  if (overlayImg.naturalWidth > 0) {
                    resolve();
                  } else {
                    reject(new Error('Image failed to load'));
                  }
                };
                overlayImg.onerror = () => reject(new Error('Image failed to load'));
              }
            });
            
            // Create a canvas with the processed overlay (grayscale, clipped, opacity, multiply)
            const overlayCanvas = document.createElement('canvas');
            overlayCanvas.width = 1200;
            overlayCanvas.height = 720;
            const octx = overlayCanvas.getContext('2d');
            
            // First, draw the background shape to multiply with
            const backgroundShape = poster.querySelector('.background-shape svg path');
            if (backgroundShape) {
              octx.fillStyle = '#A53E09'; // Match the background color
              octx.beginPath();
              octx.moveTo(0, 360); // 1240 - 880 = 360 (50% of 720)
              octx.lineTo(1200, 0);
              octx.lineTo(1200, 720);
              octx.lineTo(0, 720);
              octx.closePath();
              octx.fill();
            }
            
            // Apply clipping path for the overlay
            octx.beginPath();
            octx.moveTo(0, 360); // 50% of 720
            octx.lineTo(1200, 0);
            octx.lineTo(1200, 720);
            octx.lineTo(0, 720);
            octx.closePath();
            octx.clip();
            
            // Set multiply blend mode and draw overlay
            octx.globalCompositeOperation = 'multiply';
            octx.filter = 'grayscale(100%)';
            octx.globalAlpha = 0.8;
            octx.drawImage(overlayImg, 0, 0, 1200, 720);
            
            // Create container for the processed overlay canvas
            tempCanvasContainer = document.createElement('div');
            tempCanvasContainer.style.cssText = 'position: absolute; top: 880px; left: 0; width: 1200px; height: 720px; pointer-events: none; z-index: 1;';
            tempCanvasContainer.appendChild(overlayCanvas);
            
            // Hide original overlay and insert processed version
            originalOverlayParent.style.display = 'none';
            poster.querySelector('.background-layer').appendChild(tempCanvasContainer);
          } catch (imageError) {
            console.warn('Overlay image failed to load, exporting without overlay:', imageError);
            // Continue without overlay image
          }
        }

        // Temporarily disable contenteditable to avoid selection issues
        const editableElements = poster.querySelectorAll('[contenteditable="true"]');
        editableElements.forEach(el => {
          el.setAttribute('contenteditable', 'false');
          // Remove focus styles
          el.blur();
        });

        // Use html2canvas to capture the poster
        const canvas = await html2canvas(poster, {
          backgroundColor: null,
          scale: 2, // Higher quality
          logging: false,
          width: 1200,
          height: 1600,
          windowWidth: 1200,
          windowHeight: 1600,
          useCORS: true // Enable CORS for external images
        });

        // Restore overlay
        if (tempCanvasContainer) {
          tempCanvasContainer.remove();
          originalOverlayParent.style.display = '';
        }

        // Restore transform
        poster.style.transform = currentTransform;

        // Re-enable contenteditable
        editableElements.forEach(el => {
          el.setAttribute('contenteditable', 'true');
        });

        // Convert canvas to blob and download
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          
          // Extract policy code from current URL
          let fileName = 'pple-poster';
          if (currentPolicyUrl) {
            const policyCode = currentPolicyUrl.split('/').pop();
            fileName = `pple-poster-${policyCode}`;
          }
          
          link.download = `${fileName}.png`;
          link.href = url;
          link.click();
          URL.revokeObjectURL(url);

          button.disabled = false;
          button.innerHTML = originalContent;
        });
      } catch (error) {
        console.error('Export error:', error);
        alert('Error exporting PNG: ' + error.message);
        button.disabled = false;
        button.innerHTML = originalContent;

        // Restore transform
        poster.style.transform = currentTransform;

        // Make sure to re-enable contenteditable on error
        const editableElements = document.getElementById('poster').querySelectorAll('[contenteditable="true"]');
        editableElements.forEach(el => {
          el.setAttribute('contenteditable', 'true');
        });
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Store original content
      document.querySelectorAll('[contenteditable="true"]').forEach(el => {
        originalContent[el.className] = el.innerHTML;
      });
      
      // Generate initial QR code
      updateQRCode();
      
      // Load policy list
      loadPolicyList();
      
      // Scale poster to fit
      scalePosterToFit();
      
      // Re-scale on window resize
      window.addEventListener('resize', scalePosterToFit);
    });
  </script>
</body>

</html>