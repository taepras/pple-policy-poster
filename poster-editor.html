<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPLE Policy Poster Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
        }

        .toolbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .toolbar h1 {
            margin: 0;
            font-size: 24px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-buttons {
            display: flex;
            gap: 10px;
        }

        .info-banner {
            background: #edf2f7;
            padding: 12px 30px;
            color: #4a5568;
            font-size: 14px;
            border-bottom: 1px solid #e2e8f0;
        }

        .edit-popup {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 20px;
            z-index: 1000;
            display: none;
            min-width: 400px;
            max-width: 600px;
        }

        .edit-popup.active {
            display: block;
        }

        .edit-popup h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #2d3748;
        }

        .edit-popup textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
        }

        .edit-popup textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .edit-popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .preview-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
            overflow: auto;
        }

        .preview-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 20px;
            max-width: 1240px;
            width: 100%;
        }

        #svgPreview {
            width: 100%;
            height: auto;
            display: block;
            cursor: default;
        }

        #svgPreview text {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        #svgPreview text:hover {
            opacity: 0.7;
        }

        #svgPreview text.editing {
            outline: 2px solid #667eea;
            outline-offset: 5px;
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar h1 {
                font-size: 20px;
            }

            .toolbar-buttons {
                flex-direction: column;
            }

            .edit-popup {
                min-width: 300px;
                max-width: calc(100vw - 40px);
            }
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/>
                </svg>
                Poster Editor
            </h1>
            <div class="toolbar-buttons">
                <button class="btn-secondary" onclick="resetToOriginal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Reset
                </button>
                <button class="btn-primary" onclick="exportAsPNG()" id="exportBtn">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export PNG
                </button>
            </div>
        </div>

        <!-- Info Banner -->
        <div class="info-banner">
            ðŸ’¡ Click on any text in the poster to edit it. Press Enter for new lines.
        </div>

        <!-- Preview Area -->
        <div class="preview-container">
            <div class="preview-wrapper">
                <div id="svgPreview"></div>
            </div>
        </div>
    </div>

    <!-- Edit Popup -->
    <div class="edit-popup" id="editPopup">
        <h3 id="popupTitle">Edit Text</h3>
        <textarea id="popupTextarea"></textarea>
        <div class="edit-popup-buttons">
            <button class="btn-secondary" onclick="cancelEdit()">Cancel</button>
            <button class="btn-primary" onclick="applyEdit()">Apply</button>
        </div>
    </div>

    <script>
        let originalSVG = '';
        let svgDoc = null;
        let currentEditingElement = null;
        let currentConfigId = null;
        let lineInfoStore = {};

        const textConfig = [
            { 
                id: 'policy-number', 
                label: 'Policy Number (à¹‚à¸™à¸¢à¸šà¸²à¸¢à¸žà¸£à¸£à¸„à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™)', 
                defaultValue: 'à¹‚à¸™à¸¢à¸šà¸²à¸¢à¸žà¸£à¸£à¸„à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ 1/200',
                selector: 'g[filter*="filter0"] text',
                multiline: false
            },
            { 
                id: 'main-title', 
                label: 'Main Title', 
                defaultValue: 'à¸ªà¸¹à¹ˆà¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸°à¸¥à¸±à¸-\nà¸•à¸±à¸”à¸£à¸²à¸„à¸²-à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡:\nà¸›à¸à¸›à¹‰à¸­à¸‡à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡\nà¹à¸¥à¸° SMEs à¹„à¸—à¸¢',
                selector: 'g[filter*="filter1"] text',
                multiline: true
            },
            { 
                id: 'subtitle', 
                label: 'Description', 
                defaultValue: 'à¹ƒà¸Šà¹‰ Fast Track à¸ªà¸à¸±à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸¸à¹ˆà¸¡à¸•à¸¥à¸²à¸” \nà¸¥à¸”à¹€à¸§à¸¥à¸²à¹„à¸•à¹ˆà¸ªà¸§à¸™ 40% à¸¡à¸µ AI à¹€à¸à¹‰à¸²à¸£à¸°à¸§à¸±à¸‡à¸™à¸³à¹€à¸‚à¹‰à¸² \nà¸•à¸±à¹‰à¸‡à¸—à¸µà¸¡à¸žà¸µà¹ˆà¹€à¸¥à¸µà¹‰à¸¢à¸‡à¸Šà¹ˆà¸§à¸¢ SMEs à¹€à¸žà¸·à¹ˆà¸­à¸˜à¸¸à¸£à¸à¸´à¸ˆà¹„à¸—à¸¢',
                selector: 'g[filter*="filter2"] text',
                multiline: true
            },
            { 
                id: 'qr-text', 
                label: 'QR Code Text', 
                defaultValue: 'à¸—à¸³à¸—à¸³à¹„à¸¡? à¸—à¸³à¸­à¸°à¹„à¸£? à¸—à¸³à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£?\nà¸­à¹ˆà¸²à¸™à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸™à¹‚à¸¢à¸šà¸²à¸¢à¸™à¸µà¹‰à¸•à¹ˆà¸­à¹„à¸”à¹‰à¸—à¸µà¹ˆà¸™à¸µà¹ˆ',
                selector: 'text[y="1078.56"]',
                multiline: true
            },
            { 
                id: 'qr-url', 
                label: 'Policy URL', 
                defaultValue: 'https://election69.peoplesparty.or.th/policy/3/A-1-4',
                selector: 'text[fill="#FF6413"][font-size="24"] tspan',
                multiline: false
            },
            { 
                id: 'vote-date', 
                label: 'Voting Date', 
                defaultValue: '8 à¸à¸¸à¸¡à¸ à¸²\nà¸à¸² 2 à¹ƒà¸š à¹ƒà¸«à¹‰',
                selector: 'text[y="1400.2"]',
                multiline: true
            },
            { 
                id: 'party-name', 
                label: 'Party Name', 
                defaultValue: 'à¸žà¸£à¸£à¸„à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™',
                selector: 'text[y="1496.2"] tspan',
                multiline: false
            },
            { 
                id: 'ballot-number', 
                label: 'Ballot Number', 
                defaultValue: '46',
                selector: 'text[font-size="84"] tspan',
                multiline: false
            },
            { 
                id: 'ballot-text', 
                label: 'Ballot Text', 
                defaultValue: 'à¹€à¸¥à¸·à¸­à¸à¸šà¸±à¸à¸Šà¸µà¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹€à¸šà¸­à¸£à¹Œ 46',
                selector: 'text[y="1533.42"] tspan',
                multiline: false
            }
        ];

        // Load the SVG file
        async function loadSVG() {
            try {
                const response = await fetch('template/template_example.svg');
                originalSVG = await response.text();
                
                // Parse SVG and insert into DOM
                const parser = new DOMParser();
                svgDoc = parser.parseFromString(originalSVG, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;
                
                const previewDiv = document.getElementById('svgPreview');
                previewDiv.innerHTML = '';
                previewDiv.appendChild(svgElement);
                
                // Setup click handlers for text elements
                setupTextClickHandlers();
                
            } catch (error) {
                console.error('Error loading SVG:', error);
                alert('Failed to load SVG template. Please check that template/template_example.svg exists.');
            }
        }

        function setupTextClickHandlers() {
            textConfig.forEach(config => {
                const textElement = document.querySelector(`#svgPreview ${config.selector}`);
                if (textElement) {
                    // Store line info
                    const tspans = textElement.querySelectorAll('tspan');
                    const lineInfo = [];
                    tspans.forEach(tspan => {
                        lineInfo.push({
                            x: tspan.getAttribute('x'),
                            y: tspan.getAttribute('y')
                        });
                    });
                    lineInfoStore[config.id + '_lineInfo'] = lineInfo;

                    // Add click handler
                    textElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditPopup(textElement, config);
                    });

                    // Store config reference
                    textElement.dataset.configId = config.id;
                } else {
                    console.warn('Text element not found for selector:', config.selector);
                }
            });
        }

        function openEditPopup(textElement, config) {
            currentEditingElement = textElement;
            currentConfigId = config.id;

            // Get current text
            const tspans = textElement.querySelectorAll('tspan');
            const lines = Array.from(tspans).map(t => t.textContent);
            const currentText = lines.join('\n');

            // Setup popup
            document.getElementById('popupTitle').textContent = config.label;
            document.getElementById('popupTextarea').value = currentText;

            // Position popup near the clicked element
            const popup = document.getElementById('editPopup');
            const rect = textElement.getBoundingClientRect();
            popup.style.left = Math.min(rect.right + 20, window.innerWidth - 420) + 'px';
            popup.style.top = Math.max(rect.top, 20) + 'px';

            // Show popup
            popup.classList.add('active');
            textElement.classList.add('editing');
            document.getElementById('popupTextarea').focus();
        }

        function cancelEdit() {
            const popup = document.getElementById('editPopup');
            popup.classList.remove('active');
            if (currentEditingElement) {
                currentEditingElement.classList.remove('editing');
            }
            currentEditingElement = null;
            currentConfigId = null;
        }

        function applyEdit() {
            if (!currentEditingElement || !currentConfigId) return;

            const newText = document.getElementById('popupTextarea').value;
            updateText(currentConfigId, newText);

            cancelEdit();
        }

        function updateText(configId, value) {
            const textElement = document.querySelector(`#svgPreview text[data-config-id="${configId}"]`);
            if (!textElement) return;

            const config = textConfig.find(c => c.id === configId);
            if (!config) return;

            // Get stored line info
            const lineInfo = lineInfoStore[configId + '_lineInfo'] || [];
            
            // Clear existing tspans
            while (textElement.firstChild) {
                textElement.removeChild(textElement.firstChild);
            }

            if (config.multiline) {
                // Split by newlines
                const lines = value.split('\n');
                
                // Get font size for line height calculation
                const fontSize = parseFloat(textElement.getAttribute('font-size') || '16');
                const lineHeight = fontSize * 1.2;

                lines.forEach((lineText, index) => {
                    const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspan.textContent = lineText;
                    
                    // Set position from stored info or calculate new position
                    if (lineInfo[index]) {
                        tspan.setAttribute('x', lineInfo[index].x);
                        tspan.setAttribute('y', lineInfo[index].y);
                    } else if (index > 0 && lineInfo[index - 1]) {
                        // Calculate position for new lines
                        tspan.setAttribute('x', lineInfo[0].x);
                        const prevY = parseFloat(lineInfo[index - 1].y);
                        tspan.setAttribute('y', (prevY + lineHeight).toString());
                    } else if (index === 0 && lineInfo.length > 0) {
                        tspan.setAttribute('x', lineInfo[0].x);
                        tspan.setAttribute('y', lineInfo[0].y);
                    }
                    
                    textElement.appendChild(tspan);
                });
            } else {
                // Single line
                const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                tspan.textContent = value;
                if (lineInfo[0]) {
                    tspan.setAttribute('x', lineInfo[0].x);
                    tspan.setAttribute('y', lineInfo[0].y);
                }
                textElement.appendChild(tspan);
            }
        }

        // Export as PNG
        async function exportAsPNG() {
            const button = document.getElementById('exportBtn');
            const originalContent = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> Exporting...';
            
            try {
                const svgElement = document.getElementById('svgPreview').querySelector('svg');
                const svgData = new XMLSerializer().serializeToString(svgElement);
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 1200;
                canvas.height = 1600;
                
                const img = new Image();
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob(function(blob) {
                        const downloadUrl = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = 'pple-poster-' + Date.now() + '.png';
                        link.href = downloadUrl;
                        link.click();
                        
                        URL.revokeObjectURL(downloadUrl);
                        URL.revokeObjectURL(url);
                        
                        button.disabled = false;
                        button.innerHTML = originalContent;
                    });
                };
                
                img.onerror = function() {
                    alert('Error exporting PNG. Please try again.');
                    button.disabled = false;
                    button.innerHTML = originalContent;
                };
                
                img.src = url;
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting PNG: ' + error.message);
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        // Reset to original
        function resetToOriginal() {
            if (confirm('Are you sure you want to reset all changes?')) {
                loadSVG();
            }
        }

        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('editPopup');
            if (popup.classList.contains('active') && !popup.contains(e.target)) {
                cancelEdit();
            }
        });

        // Prevent popup from closing when clicking inside it
        document.getElementById('editPopup').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', loadSVG);
    </script>
</body>
</html>
