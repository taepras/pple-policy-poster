<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPLE Policy Poster Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 40px);
        }

        .sidebar h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .sidebar p {
            font-size: 14px;
            color: #718096;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .editor-section {
            margin-bottom: 25px;
        }

        .editor-section h2 {
            font-size: 16px;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .text-item {
            margin-bottom: 15px;
        }

        .text-item label {
            display: block;
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .text-item input,
        .text-item textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .text-item input:focus,
        .text-item textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-item textarea {
            min-height: 80px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .preview-container {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
            background: #ffffff;
        }

        .preview-wrapper {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 100%;
        }

        #svgPreview {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 5px;
        }

        .icon {
            width: 18px;
            height: 18px;
        }

        .info-box {
            background: #ebf4ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #2d3748;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .preview-container {
                min-height: 500px;
            }
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h1>üìù Poster Editor</h1>
            <p>Edit the text fields below to customize your PPLE policy poster.</p>
            
            <div class="info-box">
                üí° <strong>Tip:</strong> Changes are applied in real-time. Click "Export as PNG" when you're done.
            </div>

            <div class="editor-section">
                <h2>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit Text Content
                </h2>

                <div id="textInputs">
                    <!-- Text inputs will be generated here -->
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="exportBtn">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export as PNG
                </button>
                <button class="btn-secondary" id="resetBtn">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Reset to Original
                </button>
            </div>
        </aside>

        <main class="preview-container">
            <div class="preview-wrapper">
                <svg id="svgPreview" viewBox="0 0 1200 1600" xmlns="http://www.w3.org/2000/svg"></svg>
            </div>
        </main>
    </div>

    <script>
        // Store the original SVG content
        let originalSVG = '';
        let svgContent = '';
        const textOverlays = new Map();

        // Text mapping - matches actual text elements in SVG
        const textConfig = [
            { 
                id: 'policy-number', 
                label: 'Policy Number (‡πÇ‡∏ô‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)', 
                defaultValue: '‡πÇ‡∏ô‡∏¢‡∏ö‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 1/200',
                selector: 'g[filter*="filter0"] text',
                multiline: false
            },
            { 
                id: 'main-title', 
                label: 'Main Title', 
                defaultValue: '‡∏™‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∞‡∏•‡∏±‡∏Å-\n‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤-‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°:\n‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°\n‡πÅ‡∏•‡∏∞ SMEs ‡πÑ‡∏ó‡∏¢',
                selector: 'g[filter*="filter1"] text',
                multiline: true
            },
            { 
                id: 'subtitle', 
                label: 'Description', 
                defaultValue: '‡πÉ‡∏ä‡πâ Fast Track ‡∏™‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡πà‡∏°‡∏ï‡∏•‡∏≤‡∏î \n‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ï‡πà‡∏™‡∏ß‡∏ô 40% ‡∏°‡∏µ AI ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ \n‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏°‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡πà‡∏ß‡∏¢ SMEs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏ó‡∏¢',
                selector: 'g[filter*="filter2"] text',
                multiline: true
            },
            { 
                id: 'qr-text', 
                label: 'QR Code Text', 
                defaultValue: '‡∏ó‡∏≥‡∏ó‡∏≥‡πÑ‡∏°? ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£? ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?\n‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà',
                selector: 'text[y="1078.56"]',
                multiline: true
            },
            { 
                id: 'qr-url', 
                label: 'Policy URL', 
                defaultValue: 'https://election69.peoplesparty.or.th/policy/3/A-1-4',
                selector: 'text[fill="#FF6413"][font-size="24"] tspan',
                multiline: false
            },
            { 
                id: 'vote-date', 
                label: 'Voting Date', 
                defaultValue: '8 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤\n‡∏Å‡∏≤ 2 ‡πÉ‡∏ö ‡πÉ‡∏´‡πâ',
                selector: 'text[y="1400.2"]',
                multiline: true
            },
            { 
                id: 'party-name', 
                label: 'Party Name', 
                defaultValue: '‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô',
                selector: 'text[y="1496.2"] tspan',
                multiline: false
            },
            { 
                id: 'ballot-number', 
                label: 'Ballot Number', 
                defaultValue: '46',
                selector: 'text[font-size="84"] tspan',
                multiline: false
            },
            { 
                id: 'ballot-text', 
                label: 'Ballot Text', 
                defaultValue: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå 46',
                selector: 'text[y="1533.42"] tspan',
                multiline: false
            }
        ];

        // Load the SVG file
        async function loadSVG() {
            try {
                const response = await fetch('template/template_example.svg');
                const svgText = await response.text();
                originalSVG = svgText;
                svgContent = svgText;
                
                // Parse and display the SVG
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const importedSVG = svgDoc.documentElement;
                
                // Replace the placeholder SVG with the loaded one
                const previewWrapper = document.querySelector('.preview-wrapper');
                const oldSVG = document.getElementById('svgPreview');
                oldSVG.remove();
                importedSVG.id = 'svgPreview';
                previewWrapper.appendChild(importedSVG);
                
                // Generate input fields and add text overlays
                generateTextInputs();
                addTextOverlays();
            } catch (error) {
                console.error('Error loading SVG:', error);
                alert('Error loading the SVG file. Please make sure template/template_example.svg exists.');
            }
        }

        // Generate text input fields
        function generateTextInputs() {
            const container = document.getElementById('textInputs');
            container.innerHTML = '';

            textConfig.forEach(config => {
                const div = document.createElement('div');
                div.className = 'text-item';
                
                const label = document.createElement('label');
                label.textContent = config.label;
                label.setAttribute('for', config.id);
                
                if (config.multiline) {
                    const textarea = document.createElement('textarea');
                    textarea.id = config.id;
                    textarea.value = config.defaultValue;
                    textarea.dataset.configId = config.id;
                    textarea.rows = 3;
                    textarea.addEventListener('input', (e) => updateText(config.id, e.target.value));
                    div.appendChild(label);
                    div.appendChild(textarea);
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = config.id;
                    input.value = config.defaultValue;
                    input.dataset.configId = config.id;
                    input.addEventListener('input', (e) => updateText(config.id, e.target.value));
                    div.appendChild(label);
                    div.appendChild(input);
                }
                
                container.appendChild(div);
            });
        }

        // Initialize text elements references
        function addTextOverlays() {
            const svgPreview = document.getElementById('svgPreview');

            textConfig.forEach(config => {
                // Find the text element using the selector
                const textElement = svgPreview.querySelector(config.selector);
                if (textElement) {
                    textOverlays.set(config.id, textElement);
                    // Store the initial text to extract line positions
                    const tspans = textElement.querySelectorAll('tspan');
                    if (tspans.length > 0) {
                        const lineInfo = Array.from(tspans).map(tspan => ({
                            x: tspan.getAttribute('x'),
                            y: tspan.getAttribute('y')
                        }));
                        textOverlays.set(config.id + '_lineInfo', lineInfo);
                    }
                } else {
                    console.warn(`Text element not found for selector: ${config.selector}`);
                }
            });
        }

        // Update text element
        function updateText(configId, newText) {
            const textElement = textOverlays.get(configId);
            if (!textElement) return;

            const config = textConfig.find(c => c.id === configId);
            if (!config) return;

            if (config.multiline) {
                // Split text by newlines
                const lines = newText.split('\n');
                const lineInfo = textOverlays.get(configId + '_lineInfo') || [];
                
                // Clear existing content
                textElement.innerHTML = '';
                
                // Create tspan for each line
                lines.forEach((line, index) => {
                    const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspan.textContent = line;
                    
                    // Use stored line positions or calculate new ones
                    if (lineInfo[index]) {
                        tspan.setAttribute('x', lineInfo[index].x);
                        tspan.setAttribute('y', lineInfo[index].y);
                    } else if (index === 0) {
                        // First line - use text element's position
                        const x = textElement.getAttribute('x') || lineInfo[0]?.x || '120';
                        const y = textElement.getAttribute('y') || lineInfo[0]?.y || '164';
                        tspan.setAttribute('x', x);
                        tspan.setAttribute('y', y);
                    } else {
                        // Subsequent lines - increment y position based on font size
                        const prevLineInfo = lineInfo[index - 1] || lineInfo[0];
                        const prevY = parseFloat(prevLineInfo?.y || '164');
                        const fontSize = parseFloat(textElement.getAttribute('font-size') || '40');
                        const lineHeight = fontSize * 1.2;
                        const x = lineInfo[0]?.x || textElement.getAttribute('x') || '120';
                        tspan.setAttribute('x', x);
                        tspan.setAttribute('y', prevY + lineHeight);
                    }
                    
                    textElement.appendChild(tspan);
                });
            } else {
                // Single line - update text content directly
                textElement.textContent = newText;
            }
        }

        // Update preview with new text
        function updatePreview() {
            // Text is updated in real-time via updateText
            console.log('Preview updated');
        }

        // Export as PNG
        async function exportAsPNG() {
            const button = document.getElementById('exportBtn');
            const originalContent = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> Exporting...';
            
            try {
                const svgElement = document.getElementById('svgPreview');
                const svgData = new XMLSerializer().serializeToString(svgElement);
                
                // Create a canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size (same as SVG viewBox)
                canvas.width = 1200;
                canvas.height = 1600;
                
                // Create an image from the SVG
                const img = new Image();
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = function() {
                    // Draw the image on canvas
                    ctx.drawImage(img, 0, 0);
                    
                    // Convert canvas to PNG
                    canvas.toBlob(function(blob) {
                        // Download the PNG
                        const downloadUrl = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = 'pple-poster-' + Date.now() + '.png';
                        link.href = downloadUrl;
                        link.click();
                        
                        // Cleanup
                        URL.revokeObjectURL(downloadUrl);
                        URL.revokeObjectURL(url);
                        
                        button.disabled = false;
                        button.innerHTML = originalContent;
                    });
                };
                
                img.onerror = function() {
                    alert('Error exporting PNG. Please try again.');
                    button.disabled = false;
                    button.innerHTML = originalContent;
                };
                
                img.src = url;
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting PNG: ' + error.message);
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        // Reset to original
        function resetToOriginal() {
            if (confirm('Are you sure you want to reset all changes?')) {
                // Reset input values to defaults
                textConfig.forEach(config => {
                    const input = document.getElementById(config.id);
                    if (input) {
                        input.value = config.defaultValue;
                        updateTextOverlay(config.id, config.defaultValue);
                    }
                });
            }
        }

        // Event listeners
        document.getElementById('exportBtn').addEventListener('click', exportAsPNG);
        document.getElementById('resetBtn').addEventListener('click', resetToOriginal);

        // Initialize
        loadSVG();
    </script>
</body>
</html>
